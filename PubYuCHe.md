---
timezone: Asia/Taipei
---

# PubYuCHe

1. 自我介绍: Hello，大家好，第一次參加以太坊協議殘酷共學，之前做過私有鏈。期待對以太坊底層協議有更深刻的理解。
2. 你认为你会完成本次残酷学习吗？會的

## Notes

<!-- Content_START -->

### 2025.02.06
EPF #1 week
協定的基本原則
    該協定會隨著時間而改變，每次網路升級都會帶來新的改進。儘管架構不斷變化，但它的演變反映了一些基本原則。具體可總結如下：
    簡單性、通用性、模組化、無歧視性、敏捷性
實施的方式
    執行層（EL）或共識層（CL）的實作稱為客戶端。運行此客戶端並連接到網路的電腦稱為節點。因此，一個節點是一對積極參與網路的 EL 和 CL客戶端
開發週期
    新功能或變更的傳統開發週期是Idea - Research - Development - Testing - Adoption。然而，在這個循環的任何時候都可能出現問題，導致需要從頭開始再次迭代。

改進方式
    使用EIP 流程來協調來自社區的想法和提議的變更.

### 2025.02.07
觀看EL 的設計概念
狀態轉換函數（STF）
- 所需參數：
 - parent block（需要驗證從父區塊到目前區塊的轉換邏輯）
 - current block
 - StateDB（最後已知的有效狀態，儲存與父區塊相關的所有狀態資料）
- 回傳結果：
 - 更新 stateDB（包括當前區塊的資訊）
 - 錯誤（如果函數失敗且沒有更新 StateDB）
- 步驟 1：驗證標題
 - 如果發生以下情況，則可能發生錯誤
 - gas 限制變化超過前一個區塊的 1/1024
 - 區塊編號不是連續的
 - EIP-1559 基本費用未正確更新
 - ETC。
- 步驟 2：如果標題正確，則套用 Tx
 - 遍歷區塊交易，透過虛擬機器執行每個交易，如果交易正確則更新狀態
 - 如果發生以下情況，則可能發生錯誤
 - 存在無效交易，則整個區塊無效，狀態不會更新

### 2025.02.11

區塊建立函數

1. 參數部分
- 環境 (Environment)： 這部分提供了區塊生成過程所必需的基本背景信息，例如當前時間、區塊鏈中的位置（區塊編號）、前一個區塊的資訊以及區塊費用的基準值。這些數據對確保區塊的正確生成和區塊鏈的連續性非常重要。
- 交易池 (Tx pool)： 這是一個臨時儲存待執行交易的集合。系統會根據交易的價值（例如支付的手續費）來排序，確保高價值交易能夠優先被執行，從而最大化收益。
- 狀態資料庫 (StateDB)： 此資料庫保存著所有與賬戶、合約狀態等相關的信息，任何交易執行後都可能對這些狀態做出改變，故需在區塊生成後更新。
2. 返回結果
- 區塊 (Block)： 生成的新區塊，包含了一系列已執行的交易及相關區塊資訊。
- 更新後的狀態資料庫 (Updated StateDB)： 反映了所有交易執行後的最新狀態，這是整個區塊鏈運行過程中的核心數據。
- 錯誤 (Error)： 在區塊生成或交易執行過程中可能出現錯誤，這一部分用來返回和記錄相關錯誤信息。
步驟詳解
步驟 1：追蹤 gas 使用量並存儲交易
- 在這一階段，系統不斷從交易池中選取交易，並將它們加入到待生成的區塊中，同時監控累積的 gas 消耗。當達到預定的 gas 限制時，就不再添加新的交易，確保區塊不會因為交易數量過多而超出計算或存儲的限制。
這裡提到的「gas」是 Ethereum 用來衡量計算工作量的單位，每個區塊都有一個最大 gas 限制（例如 3000 萬），以防止過多計算影響網絡穩定性。
步驟 2：從交易池中取得並執行最佳交易
- 使用 Pop() 方法從排序好的交易池中取出最有價值的交易。這裡的「最佳」交易通常是指那些支付較高手續費的交易，因為礦工（或驗證者）傾向於優先處理這些交易以獲取更多收益。
交易通過 Ethereum 的虛擬機（VM）進行執行，執行結果會更新狀態資料庫，並將成功執行的交易記錄到區塊中。
如果在執行過程中某筆交易被發現無效（例如簽名錯誤或執行失敗），系統會記錄錯誤，但仍會繼續處理後續交易，直到沒有足夠的 gas 或交易池被清空。
步驟 3：使用 Finalize 函數組裝區塊
- 最後，Finalize 函數會根據已執行的交易列表以及區塊相關的資訊（如區塊頭資料）生成一個完整且可驗證的區塊。這個區塊會被添加到區塊鏈上，成為區塊鏈歷史的一部分。


狀態轉移函數

newPayload 函數：

起點與檢查： 此函數是從共識層（CL）觸發的，代表一個新的區塊提案進入流程。執行層（EL）在這個階段會檢查區塊的完整性，例如確認區塊數據的正確性與一致性。
流程延伸： 當初步檢查通過後，流程深入到 insertBlockWithoutSetHead，正式啟動區塊的鏈上添加操作。
insertBlockWithoutSetHead 函數：

執行與驗證： 這個函數負責將區塊中的交易執行，並對區塊內容進行各項驗證。驗證通過後，將區塊及其交易狀態寫入資料庫。
區別與後續： 與 insertChain 函數不同，此處不會立即更新正則鏈狀態，而是需要後續額外的 SetCanonical 操作來最終確定區塊在正則鏈中的地位。這種分步驟的設計有助於更細緻地控制區塊的驗證與最終確認過程。
insertChain 函數及其子流程：

verifyHeaders： 在正式執行區塊之前，首先必須對區塊頭進行嚴格檢查。這包括：
EIP-1559 屬性： 確保區塊頭中的 gas 限制符合網絡規範。
其他檢查項目： 如 gas 限制、實際使用的 gas、區塊生成時間等，確保整體數據正確無誤。
驗證通過後，區塊才被認為是有效的，可進入下一步執行。
Process 函數：
參數與執行環境： 該函數需要區塊數據、狀態資料庫以及虛擬機配置。這些參數共同確保區塊在執行過程中能夠正確地影響狀態。
狀態轉移機制： Geth 使用 state_processor 來完成狀態轉移。這個過程將每筆交易依次執行，更新狀態資料庫，並計算出新的狀態。
後續更新： 當所有交易都處理完畢後，系統會更新其他關鍵指標，最終把區塊的最終狀態寫入區塊鏈，確保區塊成為鏈上歷史的一部分。

### 2025.02.12

<!-- Content_END -->
